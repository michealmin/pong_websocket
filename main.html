<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script src="/static/phaser.js"></script>
    <!-- <script type="module" src="static/js/game_main.js"></script> -->
    <link rel="stylesheet" type="text/css" href="static/css/main.css">
    <script type="module">
        import {GameMain} from '/static/js/game_main.js';

        var game_main = null;

        function enterRoom(room_no, token, player_name) {
            var ori = window.location.origin;
            if (null !== game_main) {
                game_main.destroy();
                $('div.game-screen canvas').remove();
            }

            game_main = new GameMain(ori, () => {
                $('div.login-screen').show();
                $('div.game-screen').hide();
                $('div.status p.status').text('Connection closed');
            });


            game_main.createGame();

            var id = setInterval(() => {
                if (game_main.isScenesActive()) {
                    game_main.initConnection('ws://' + window.location.host + '/room/');
                    game_main.enterRoom(room_no, token, player_name, () => {
                        console.log('EnterRoom!!!!!');
                        console.log('EnterRoom!!!!!');
                        console.log('EnterRoom!!!!!');
                        $('div.login-screen').hide();
                        $('div.game-screen').show();
                    });
                    clearInterval(id);

                }
            }, 100);
        }

        function exitRoom() {
            if (null !== game_main) {
                game_main.exitRoom();
            }
        }


        function login() {
            console.log('Start login...');
            $.ajax({
                url: '/lobby/room',
                type: "POST",
                data: JSON.stringify({
                    type: 'requestEnterRoom'
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    console.log('recv room data : ' + JSON.stringify(data));
                    enterRoom(data.room_no, data.token, $('input#player-name')[0].value);
                }
            });
        }

        $(function () {
            $('button#login').click(login);
            $('button#exit-room').click(exitRoom);
        });
    </script>

</head>

<body>
    <div class="status">
        <p class="status"></p>
    </div>

    <div class="login-screen">
        <label for="player-name">이름</label>
        <input type="text" id="player-name" />
        <button id="login">로그인</button>
    </div>

    <div class="game-screen" style="display:None;">
        <button id="exit-room">나가기</button>

    </div>
</body>

</html>